package com.Huard.PhoneRFFL;

import android.os.Bundle;
import android.os.Looper;
import android.util.Pair;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;
import androidx.lifecycle.ViewModelProvider;

public class SimulationFragment extends Fragment {
    private boolean isConnected = false;  // loop through synthetic data if not connected
    public TextView lblSimulation;
    public TextView lblLogging;
    private ChannelViewModel channelViewModel;
    private LoggingViewModel loggingViewModel;
    short[][] ADC_Values_Azimuth;
    short[][] ADC_Values_Elevation;
    private final long samplePeriod_msec = 20;

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        return inflater.inflate(R.layout.fragment_simulation, container, false);
    }

    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);

        lblSimulation = view.findViewById(R.id.lblSimulation);

        lblLogging = view.findViewById(R.id.lblLogging);
        lblLogging.setOnClickListener(v -> onPressBtnLogging());

        channelViewModel = new ViewModelProvider(requireActivity()).get(ChannelViewModel.class);

        ConnectionViewModel connectionViewModel = new ViewModelProvider(requireActivity()).get(ConnectionViewModel.class);
        connectionViewModel.getIsConnected().observe(getViewLifecycleOwner(), this::receiveIsConnected);

        loggingViewModel = new ViewModelProvider(requireActivity()).get(LoggingViewModel.class);

        initializeSyntheticData();
        LoopSyntheticData();
    }

    public void onPressBtnLogging() {
        loggingViewModel.setLogExportSelected(true);
    }

    private void receiveIsConnected(boolean isConnected) {
        this.isConnected = isConnected;
        showLabel(!isConnected);
    }

    private void sendAzimuthPair(Pair<Short, Short> data) {
        channelViewModel.setAzimuth(data);
    }

    private void sendElevationPair(Pair<Short, Short> data) {
        channelViewModel.setElevation(data);
    }

    private void showLabel(boolean show) {
        if (show) {
            lblSimulation.setVisibility(View.VISIBLE);
        } else {
            lblSimulation.setVisibility(View.INVISIBLE);
        }
    }

    private void initializeSyntheticData() {
        // Data from system analysis simulation
        //String[] mockADC = "441,434,421,434, 480,474,460,474, 486,470,459,470, 390,386,378,386, 485,478,469,478, 390,388,371,388, 470,461,445,461, 390,383,373,383, 502,500,493,500, 484,473,462,473, 403,396,381,396, 416,410,402,410, 473,468,455,468, 434,428,417,428, 456,453,438,453, 467,452,445,452, 402,395,384,395, 455,448,437,448, 471,457,455,457, 428,427,416,427, 432,426,418,426, 459,447,442,447, 411,404,393,404, 446,442,430,442, 445,434,423,434, 382,369,356,369, 437,428,413,428, 381,373,363,373, 414,405,396,405, 455,447,434,447, 399,395,386,395, 432,428,414,428, 423,413,398,413, 417,409,393,409, 436,430,417,430, 372,367,352,367, 444,440,438,440, 384,373,357,373, 464,455,443,455, 511,504,497,504, 415,406,392,406, 448,447,438,447, 490,483,481,483, 476,468,457,468, 520,513,502,513, 464,457,446,457, 438,431,423,431, 531,528,514,528, 500,493,482,493, 475,470,457,470, 382,374,361,374, 468,461,449,461, 494,488,472,488, 385,369,358,369, 545,534,520,534, 501,497,489,497, 388,378,365,378, 552,543,532,543, 480,474,466,474, 389,385,373,385, 478,475,466,475, 542,534,519,534, 426,417,397,417, 496,480,466,480, 397,394,384,394, 460,454,445,454, 492,491,480,491, 424,417,401,417, 477,467,457,467, 447,444,435,444, 452,445,432,445, 453,440,429,440, 483,477,469,477, 460,454,447,454, 475,468,463,468, 490,485,473,485, 393,388,372,388, 386,382,367,382, 439,433,422,433, 396,386,373,386, 452,448,435,448, 420,412,399,412, 459,447,441,447, 451,445,429,445, 477,467,453,467, 370,365,350,365, 484,476,471,476, 475,467,457,467, 446,439,432,439, 454,443,424,443, 452,444,431,444, 448,449,436,449, 485,480,468,480, 446,439,432,439, 447,444,433,444, 375,369,358,369, 465,463,453,463, 481,476,464,476, 544,535,522,535, 477,470,458,470, 543,532,521,532, 510,506,494,506, 392,387,374,387, 484,478,464,478, 546,542,530,542, 437,425,415,425, 412,407,394,407, 403,394,382,394, 446,437,422,437, 386,378,364,378, 434,424,411,424, 533,525,516,525, 420,416,409,416, 423,410,403,410, 395,391,379,391, 505,499,489,499, 386,378,359,378, 488,480,467,480, 470,462,452,462, 407,404,394,404, 462,457,445,457, 498,491,481,491, 378,372,355,372, 400,399,386,399, 507,498,488,498, 487,484,470,484, 438,430,425,430, 414,411,400,411, 476,468,459,468, 466,458,445,458, 390,378,363,378, 455,448,439,448, 421,411,392,411, 424,419,410,419, 468,461,446,461, 445,435,427,435, 469,463,458,463, 480,475,466,475, 431,426,413,426, 404,397,380,397, 484,477,463,477, 388,374,359,374, 474,465,452,465, 433,425,417,425, 466,458,447,458, 447,442,424,442, 439,438,427,438, 467,459,449,459, 405,401,390,401, 376,366,352,366, 481,474,458,474, 464,462,449,462, 449,442,429,442, 466,461,450,461, 381,377,366,377, 489,478,467,478, 430,419,409,419, 458,449,434,449, 478,470,450,470, 398,391,375,391, 492,488,475,488, 392,386,373,386, 495,488,478,488, 435,423,409,423, 430,424,415,424, 486,480,471,480, 377,366,355,366, 498,493,477,493, 399,398,382,398, 433,420,409,420, 491,478,469,478, 431,426,412,426, 449,439,430,439, 417,405,391,405, 458,450,439,450, 469,458,445,458, 381,371,358,371, 460,455,452,455, 398,391,380,391, 467,458,442,458, 404,398,387,398, 408,399,387,399, 395,388,381,388, 410,398,387,398, 422,413,402,413, 446,442,425,442, 528,521,511,521, 457,451,437,451, 514,509,498,509, 467,458,447,458, 389,381,371,381, 526,520,512,520, 423,414,404,414, 480,471,457,471, 524,513,506,513, 487,477,470,477, 519,514,508,514, 512,513,499,513, 412,405,395,405, 491,480,472,480, 439,431,423,431, 457,449,434,449, 451,443,432,443, 405,396,389,396, 452,441,430,441, 450,445,431,445, 417,407,390,407, 392,384,375,384, 386,383,370,383, 405,392,379,392, 447,437,424,437, 492,484,479,484, 372,365,353,365, 407,399,384,399, 491,485,475,485, 512,508,492,508, 457,451,435,451, 484,477,465,477, 432,429,423,429, 418,412,399,412, 482,472,467,472, 510,509,503,509, 427,420,408,420, 502,494,483,494, 464,458,446,458, 417,406,394,406, 519,511,504,511, 449,444,431,444, 499,493,485,493, 518,512,505,512, 432,432,422,432, 503,489,484,489, 476,465,453,465, 421,417,408,417, 510,503,488,503, 514,506,498,506, 528,522,509,522, 381,378,363,378, 501,497,488,497, 490,483,469,483, 481,476,468,476, 486,477,472,477, 411,398,383,398, 487,480,469,480, 461,448,439,448, 465,458,449,458, 391,379,364,379, 510,497,486,497, 464,454,443,454, 503,496,486,496, 386,378,370,378, 402,394,380,394, 459,453,444,453, 490,476,468,476, 379,366,353,366, 514,511,502,511, 409,409,397,409, 405,396,381,396, 390,380,371,380, 376,367,355,367, 498,490,486,490, 507,500,495,500, 380,370,355,370, 373,366,355,366, 487,477,468,477, 554,545,537,545, 437,429,419,429, 473,471,456,471, 549,536,527,536, 429,422,408,422, 479,477,468,477, 499,489,476,489, 496,489,476,489, 373,370,362,370, 390,381,373,381, 425,415,407,415, 526,521,508,521, 467,461,445,461, 390,380,374,380, 505,498,486,498, 452,442,432,442, 397,386,365,386, 514,502,490,502, 531,527,515,527, 436,432,423,432, 397,387,383,387, 467,458,445,458, 468,463,456,463".split(", ");
        //String[] mockADC = "403,400,400,389, 413,414,414,406, 520,522,522,510, 522,524,524,509, 405,408,408,400, 500,500,500,496, 424,428,428,412, 495,500,500,487, 507,505,505,492, 453,458,458,444, 450,455,455,446, 466,471,471,457, 524,524,524,511, 455,455,455,447, 521,523,523,510, 560,560,560,551, 556,557,557,546, 450,441,441,430, 418,421,421,407, 448,451,451,443, 459,461,461,452, 434,437,437,422, 485,487,487,477, 487,491,491,477, 402,403,403,390, 426,418,418,412, 419,425,425,418, 399,404,404,396, 405,406,406,392, 515,517,517,506, 491,495,495,488, 395,398,398,393, 410,410,410,403, 426,423,423,411, 492,492,492,483, 535,538,538,527, 467,471,471,465, 474,474,474,467, 457,456,456,447, 455,454,454,441, 475,474,474,458, 464,464,464,455, 415,416,416,407, 404,400,400,390, 408,409,409,395, 452,454,454,439, 435,437,437,425, 451,450,450,439, 472,475,475,467, 395,397,397,385, 465,470,470,459, 475,475,475,468, 446,448,448,438, 430,436,436,426, 469,470,470,460, 471,475,475,465, 421,422,422,405, 401,402,402,394, 475,473,473,457, 464,466,466,457, 457,449,449,437, 467,473,473,460, 462,460,460,441, 438,441,441,438, 535,539,539,530, 538,544,544,532, 408,410,410,405, 526,529,529,519, 481,481,481,468, 497,498,498,484, 430,436,436,437, 499,500,500,492, 486,494,494,484, 494,494,494,485, 494,499,499,487, 497,497,497,488, 447,451,451,439, 502,501,501,489, 466,468,468,453, 428,431,431,412, 454,455,455,448, 476,477,477,463, 511,512,512,495, 509,510,510,500, 408,407,407,397, 415,417,417,413, 419,423,423,412, 469,465,465,452, 439,439,439,432, 444,444,444,435, 409,415,415,412, 449,453,453,443, 414,421,421,413, 444,441,441,430, 475,474,474,468, 469,470,470,460, 456,460,460,452, 464,466,466,451, 415,411,411,400, 399,397,397,382, 610,611,611,595, 582,588,588,571, 467,467,467,456, 555,559,559,551, 590,591,591,576, 477,484,484,467, 431,432,432,425, 413,416,416,406, 518,512,512,499, 482,484,484,475, 495,497,497,489, 412,423,423,417, 393,395,395,387, 510,508,508,497, 515,514,514,500, 421,423,423,410, 471,470,470,460, 467,468,468,458, 458,456,456,445, 434,440,440,426, 442,440,440,425, 419,423,423,414, 500,501,501,488, 476,471,471,457, 401,407,407,398, 462,464,464,455".split(", ");
        String[] mockADC = "518,520,519,520, 509,513,513,513, 469,471,470,471, 483,477,474,477, 509,514,511,514, 514,513,512,513, 477,480,476,480, 447,449,448,449, 437,443,436,443, 440,441,443,441, 440,445,442,445, 439,437,431,437, 476,484,477,484, 486,485,477,485, 503,508,506,508, 446,451,450,451, 479,477,475,477, 471,472,464,472, 506,509,506,509, 502,494,485,494, 461,458,459,458, 511,511,514,511, 445,444,444,444, 493,493,487,493, 510,512,506,512, 482,489,489,489, 461,465,467,465, 496,503,502,503, 505,506,505,506, 523,522,518,522, 494,497,494,497, 474,483,481,483, 470,476,474,476, 480,477,476,477, 477,480,480,480, 447,448,447,448, 457,458,459,458, 497,497,497,497, 452,454,451,454, 490,496,488,496, 452,453,451,453, 478,476,474,476, 504,511,513,511, 490,490,484,490, 497,500,496,500, 479,477,475,477, 545,545,546,545, 472,471,471,471, 534,536,540,536, 471,477,473,477, 489,489,492,489, 486,489,487,489, 517,521,518,521, 460,461,454,461, 500,498,500,498, 448,442,442,442, 498,502,500,502, 522,527,532,527, 457,458,453,458, 462,463,458,463, 500,506,504,506, 478,482,477,482, 468,473,477,473, 460,460,453,460, 480,483,477,483, 477,478,475,478, 439,440,434,440, 439,440,432,440, 456,456,448,456, 448,453,450,453, 479,479,477,479, 498,497,496,497, 549,546,542,546, 548,549,543,549, 445,448,447,448, 511,514,518,514, 448,448,445,448, 431,435,432,435, 449,449,445,449, 451,452,447,452, 471,466,466,466, 447,444,441,444, 522,523,524,523, 443,445,444,445, 507,511,514,511, 463,462,458,462, 637,642,640,642, 694,688,689,688, 568,568,569,568, 452,448,443,448, 443,441,440,441, 522,528,532,528, 517,519,519,519, 547,548,546,548, 549,553,549,553, 506,509,506,509, 574,574,575,574, 753,756,755,756, 729,732,737,732, 613,610,608,610, 491,491,480,491, 438,443,435,443, 655,656,664,656, 552,554,550,554, 838,834,841,834, 761,765,769,765, 642,642,645,642, 514,521,523,521, 490,493,489,493, 750,750,748,750, 853,854,856,854, 633,627,628,627, 504,505,498,505, 703,702,701,702, 632,632,633,632, 640,641,641,641, 642,640,646,640, 558,563,563,563, 647,654,655,654, 518,520,522,520, 650,656,655,656, 625,625,622,625, 496,505,504,505, 812,819,822,819, 831,841,846,841, 720,718,717,718, 592,595,596,595, 482,481,471,481, 630,633,628,633, 701,703,699,703, 600,591,594,591, 478,476,475,476, 861,861,870,861, 719,719,718,719, 841,841,849,841, 603,598,594,598, 645,642,639,642, 479,480,479,480, 652,658,663,658, 540,538,535,538, 681,685,681,685, 571,563,570,563, 440,444,443,444, 699,702,705,702, 673,676,671,676, 550,553,551,553, 437,436,437,436, 685,687,684,687, 535,537,535,537, 655,659,666,659, 662,659,659,659, 594,596,593,596, 613,611,613,611, 572,572,572,572, 661,665,669,665, 458,453,452,453, 842,844,853,844, 783,791,794,791, 666,667,669,667, 549,547,541,547, 566,568,569,568, 576,579,575,579, 653,650,644,650, 622,618,621,618, 533,533,532,533, 483,485,487,485, 757,761,760,761, 852,856,864,856, 635,637,642,637, 514,518,521,518, 637,638,633,638, 613,610,610,610, 601,604,601,604, 855,856,860,856, 746,748,749,748, 516,518,513,518, 624,626,621,626, 506,508,509,508, 534,536,533,536, 628,631,630,631, 520,516,518,516, 851,852,860,852, 638,642,642,642, 769,765,773,765, 602,602,600,602, 491,497,493,497, 617,619,622,619, 637,639,643,639, 850,855,859,855, 623,624,623,624, 742,745,745,745, 503,505,504,505, 687,690,690,690, 481,479,478,479, 600,603,606,603, 485,482,478,482, 617,615,615,615, 583,581,584,581, 455,462,453,462, 782,786,782,786, 707,708,711,708, 828,831,835,831, 592,587,585,587, 587,589,591,589, 464,469,466,469, 679,680,681,680, 452,454,451,454, 568,572,571,572, 508,510,504,510, 604,603,604,603, 481,488,481,488, 513,513,511,513, 828,831,836,831, 739,737,740,737, 618,615,613,615, 492,494,500,494, 657,658,658,658, 598,599,602,599, 477,479,478,479, 476,474,476,474, 543,542,536,542, 728,727,728,727, 700,706,707,706, 584,582,579,582, 459,463,460,463, 560,564,557,564, 468,470,466,470, 583,581,576,581, 457,457,456,457, 437,442,442,442, 659,657,660,657, 694,694,696,694, 572,570,573,570, 449,453,449,453, 437,437,431,437, 536,538,535,538, 499,496,494,496, 451,460,458,460, 613,613,614,613, 733,739,735,739, 706,710,711,710, 493,490,486,490, 489,492,484,492, 562,561,560,561, 455,459,459,459, 515,522,521,522, 600,599,599,599, 707,709,711,709, 482,478,476,478, 479,481,478,481, 455,459,461,459, 577,580,573,580, 626,622,625,622, 465,464,461,464, 467,468,466,468, 625,619,621,619, 514,517,516,517, 602,599,596,599, 616,619,613,619, 476,476,477,476, 473,474,474,474, 603,601,601,601, 493,490,484,490, 511,521,517,521, 571,572,572,572, 580,584,585,584, 491,488,489,488, 546,548,547,548, 551,553,552,553, 477,475,469,475, 487,485,486,485, 465,458,457,458, 493,496,496,496, 603,600,597,600, 580,579,575,579, 502,502,499,502, 445,444,441,444, 533,528,529,528, 525,526,528,526, 482,486,487,486, 523,523,520,523, 569,572,569,572, 477,473,472,473, 510,508,501,508, 506,507,508,507, 557,559,562,559, 481,480,475,480, 521,521,520,521, 447,448,442,448, 490,485,479,485, 493,488,489,488, 491,486,485,486, 471,473,467,473, 480,488,488,488, 493,490,489,490, 489,490,486,490, 529,533,525,533, 552,551,551,551, 550,551,544,551, 448,453,453,453, 513,519,517,519, 540,540,540,540, 464,466,465,466, 539,541,536,541, 485,486,483,486, 462,464,467,464, 531,534,537,534, 438,439,434,439, 439,440,436,440, 440,446,445,446, 441,447,448,447, 435,437,434,437, 444,445,445,445, 438,445,440,445, 447,448,441,448, 453,456,452,456, 463,471,470,471, 471,472,469,472, 450,447,450,447, 524,523,522,523, 526,528,530,528, 523,524,526,524, 500,506,506,506, 527,527,513,527, 527,529,527,529, 522,532,531,532, 511,514,507,514, 525,529,526,529, 530,530,533,530, 524,525,519,525, 518,522,523,522, 525,530,530,530, 526,529,532,529, 529,531,531,531, 528,533,532,533, 533,532,535,532, 482,479,478,479, 483,484,484,484, 529,529,526,529, 534,533,528,533, 533,534,536,534, 535,532,533,532, 501,500,497,500, 531,534,533,534, 536,534,530,534, 490,493,488,493, 527,532,533,532, 531,535,534,535, 534,536,529,536, 503,510,513,510, 543,542,539,542, 547,546,547,546, 545,545,540,545, 526,528,527,528, 451,452,450,452, 438,441,437,441, 453,460,460,460, 432,437,432,437, 510,509,505,509, 454,460,458,460, 450,454,450,454, 476,481,480,481, 462,466,459,466, 443,449,443,449, 440,451,451,451, 430,435,438,435, 502,505,505,505, 477,484,480,484, 489,486,487,486, 434,435,430,435, 488,487,491,487, 494,495,497,495, 558,555,553,555, 574,576,571,576, 561,557,557,557, 437,437,436,437, 478,482,476,482, 444,445,444,445, 466,472,470,472, 444,447,447,447, 517,518,514,518, 441,444,435,444, 457,456,454,456, 487,491,484,491, 481,481,481,481, 434,437,436,437, 484,480,479,480, 451,454,454,454, 454,453,453,453, 446,446,451,446, 450,450,449,450, 458,459,459,459, 453,456,453,456, 440,441,435,441, 454,459,457,459, 463,467,461,467, 442,438,435,438, 461,464,462,464, 495,496,489,496, 441,442,438,442, 439,439,443,439, 472,476,472,476, 466,466,461,466, 489,490,488,490, 492,498,491,498, 494,492,496,492, 445,449,445,449, 491,490,487,490, 491,493,489,493, 482,486,484,486, 500,507,502,507, 513,509,504,509, 505,506,505,506, 531,534,535,534, 436,439,436,439, 473,476,475,476, 495,494,496,494, 498,497,499,497, 443,444,442,444, 537,537,536,537, 499,503,494,503, 442,445,438,445, 449,449,445,449, 466,468,464,468, 451,453,446,453, 466,467,462,467, 478,476,465,476, 489,494,484,494, 456,462,462,462, 448,448,451,448, 458,455,448,455, 515,516,515,516, 487,486,481,486, 588,586,589,586, 566,568,575,568, 452,452,456,452, 559,561,558,561, 560,555,552,555, 472,468,463,468, 575,573,569,573, 464,470,468,470, 443,448,441,448, 436,438,438,438, 461,463,464,463, 638,641,643,641, 438,441,436,441, 553,559,557,559, 563,560,559,560, 555,553,553,553, 539,535,539,535, 581,584,588,584, 492,490,489,490, 478,478,479,478, 521,521,516,521, 460,464,467,464, 524,525,530,525, 543,544,538,544, 583,582,582,582, 478,474,469,474, 582,585,583,585, 510,509,506,509, 476,476,471,476, 476,476,469,476".split(", ");

        ADC_Values_Azimuth = new short[mockADC.length][2];
        ADC_Values_Elevation = new short[mockADC.length][2];

        for (int i=0; i<mockADC.length; i++) {
            String[] ch1ch2ch3ch4 = mockADC[i].split(",");
            short ADC1 = Short.parseShort(ch1ch2ch3ch4[0]); // CH1:  ADC1 = 16.468 * dbm1 + 1155.3
            short ADC2 = Short.parseShort(ch1ch2ch3ch4[1]); // CH2:  ADC2 = 16.461 * dbm1 + 1145.5
            short ADC3 = Short.parseShort(ch1ch2ch3ch4[2]); // CH3:  ADC3 = 16.272 * dbm3 + 1131.4
            short ADC4 = Short.parseShort(ch1ch2ch3ch4[3]); // CH4:  ADC4 = 16.014 * dbm4 + 1121

            ADC_Values_Elevation[i][0] = ADC3;
            ADC_Values_Elevation[i][1] = ADC4;
            ADC_Values_Azimuth[i][0] = ADC1;
            ADC_Values_Azimuth[i][1] = ADC2;
        }
    }

    private void LoopSyntheticData() {
        Runnable loop = () -> {
            Looper.prepare();

            for (int i = 0; i < 9999; i ++) {
                if (i >= ADC_Values_Azimuth.length)  // loop over values and repeat when done
                    i = 0;

                if (!isConnected)  // only send synthetic data when disconnected
                    sendAzimuthPair(new Pair<>(ADC_Values_Azimuth[i][0], ADC_Values_Azimuth[i][1]));

                try {
                    Thread.sleep(samplePeriod_msec); // Add a delay of 20 milliseconds between iterations
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

                if (!isConnected)  // only send synthetic data when disconnected
                    sendElevationPair(new Pair<>(ADC_Values_Elevation[i][0], ADC_Values_Elevation[i][1]));

                try {
                    Thread.sleep(samplePeriod_msec); // Add a delay of 20 milliseconds between iterations
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        };

        new Thread(loop).start(); // Start the thread to work in Background
    }
}